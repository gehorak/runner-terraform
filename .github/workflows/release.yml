# =============================================================================
# Release workflow — runner-terraform
#
# PURPOSE
# -------
# Publish an immutable container image based on an explicitly validated
# Semantic Version tag.
#
# This workflow:
# - validates the release tag format (strict SemVer)
# - binds the image to an exact git commit
# - performs a minimal runtime smoke check
# - publishes a fully identifiable and auditable artifact
#
# This file is part of the platform contract.
# Any modification MUST be reviewed as a breaking change.
# =============================================================================

name: Release image


# -----------------------------------------------------------------------------
# Trigger configuration
#
# The workflow is triggered exclusively by git tags
# matching the pattern: vMAJOR.MINOR.PATCH
#
# Examples:
#   v0.1.0   → valid
#   v1.2.3   → valid
#   v1.0     → INVALID
#   v1.0.0-rc1 → INVALID
# -----------------------------------------------------------------------------

on:
  push:
    tags:
      - 'v*'


# -----------------------------------------------------------------------------
# Permissions
#
# Minimal permissions required for publishing to GHCR.
# -----------------------------------------------------------------------------

permissions:
  contents: read
  packages: write


# -----------------------------------------------------------------------------
# Jobs
# -----------------------------------------------------------------------------

jobs:

  # ===========================================================================
  # Release job
  #
  # Purpose:
  # - Build the container image for the tagged version
  # - Validate basic runtime behavior
  # - Publish the image to the container registry
  # ===========================================================================

  release:
    name: Build, validate, and publish image
    runs-on: ubuntu-latest

    steps:

      # -----------------------------------------------------------------------
      # Checkout source
      #
      # The repository is checked out exactly at the tagged commit.
      # No branch state is involved.
      # -----------------------------------------------------------------------

      - name: Checkout source at tag
        uses: actions/checkout@v4
        with:
          fetch-depth: 0


      # -----------------------------------------------------------------------
      # Validate release tag (strict SemVer)
      #
      # Accepted format:
      #   vMAJOR.MINOR.PATCH
      #
      # Any deviation fails the workflow.
      # -----------------------------------------------------------------------

      - name: Validate release tag (SemVer)
        id: semver
        shell: bash
        run: |
          set -Eeuo pipefail

          TAG="${GITHUB_REF#refs/tags/}"

          if [[ ! "$TAG" =~ ^v([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
            echo "ERROR: Invalid release tag '$TAG'"
            echo "Expected format: vMAJOR.MINOR.PATCH (e.g. v1.2.3)"
            exit 1
          fi

          MAJOR="${BASH_REMATCH[1]}"
          MINOR="${BASH_REMATCH[2]}"
          PATCH="${BASH_REMATCH[3]}"

          VERSION="${MAJOR}.${MINOR}.${PATCH}"
          VERSION_MM="${MAJOR}.${MINOR}"
          COMMIT_SHA="$(git rev-parse HEAD)"

          echo "tag=${TAG}"              >> "${GITHUB_OUTPUT}"
          echo "version=${VERSION}"      >> "${GITHUB_OUTPUT}"
          echo "version_mm=${VERSION_MM}" >> "${GITHUB_OUTPUT}"
          echo "commit=${COMMIT_SHA}"    >> "${GITHUB_OUTPUT}"


      # -----------------------------------------------------------------------
      # Ensure tag is on main
      # -----------------------------------------------------------------------

      - name: Ensure tag is on main
        shell: bash
        run: |
          set -Eeuo pipefail
          git fetch origin main
          git merge-base --is-ancestor HEAD origin/main




      # -----------------------------------------------------------------------
      # Define Docker image metadata
      #
      # OCI labels provide full artifact traceability:
      # - source repository
      # - exact commit hash
      # - build timestamp
      # -----------------------------------------------------------------------

      - name: Define Docker image metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ghcr.io/gehorak/runner-terraform
          tags: |
            type=raw,value=${{ steps.semver.outputs.version }}
            type=raw,value=${{ steps.semver.outputs.version_mm }}
            type=raw,value=latest
          labels: |
            org.opencontainers.image.title=runner-terraform
            org.opencontainers.image.description=Deterministic terraform runner image
            org.opencontainers.image.source=https://github.com/gehorak/runner-terraform
            org.opencontainers.image.version=${{ steps.semver.outputs.version }}
            org.opencontainers.image.revision=${{ steps.semver.outputs.commit }}
            org.opencontainers.image.created=${{ github.run_started_at }}


      # -----------------------------------------------------------------------
      # Authenticate to GitHub Container Registry
      # -----------------------------------------------------------------------

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}


      # -----------------------------------------------------------------------
      # Build image locally
      #
      # The image is built locally first to allow validation
      # before publication.
      # -----------------------------------------------------------------------

      - name: Build image (local)
        uses: docker/build-push-action@v6
        with:
          context: .
          load: true
          tags: runner-release:test
          labels: ${{ steps.meta.outputs.labels }}


      # -----------------------------------------------------------------------
      # Minimal runtime smoke check
      #
      # Verifies:
      # - the image can be started
      # - the runner entrypoint responds
      #
      # This is intentionally NOT a full test suite.
      # Exhaustive validation is handled by CI.
      # -----------------------------------------------------------------------

      - name: Smoke test image
        shell: bash
        run: |
          set -Eeuo pipefail
          docker run --rm runner-release:test info > /dev/null


      # -----------------------------------------------------------------------
      # Full contract validation (CI invariant)
      #
      # Release MUST re-validate the full runner contract.
      # Publishing without passing the full test suite is forbidden.
      # -----------------------------------------------------------------------

      - name: Run full contract test suite
        shell: bash
        env:
          IMAGE: runner-release:test
        run: |
          set -Eeuo pipefail
          make check


      # -----------------------------------------------------------------------
      # Publish image to GHCR
      #
      # Executed only after successful build and validation.
      # -----------------------------------------------------------------------

      - name: Publish image to GHCR
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

# -----------------------------------------------------------------------------
# End of workflow
#
# CONTRACT GUARANTEES
# -------------------
# - Only valid SemVer tags can produce a release.
# - Every published image is traceable to a specific commit.
# - A runnable image is verified before publication.
# - No image is published implicitly from any branch.
# =============================================================================
