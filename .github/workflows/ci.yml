# =============================================================================
# Continuous Integration workflow â€” runner platform
#
# This workflow defines the canonical CI pipeline for all runner-* repositories.
#
# Design goals:
# - Deterministic and reproducible builds
# - Fast failure on contract violations
# - Clear separation of build and verification stages
# - Human-readable structure suitable for long-term maintenance
#
# This workflow is intentionally conservative and explicit.
# =============================================================================

name: CI


# -----------------------------------------------------------------------------
# Trigger configuration
#
# CI is executed on:
# - every push to the default branch
# - every pull request
#
# This ensures that:
# - all changes are validated before merge
# - the default branch always remains releasable
# -----------------------------------------------------------------------------

on:
  push:
    branches:
      - '**'
    tags-ignore:
      - 'v*'  # Ignore version tags
  pull_request:
    branches:
      - '**'


# -----------------------------------------------------------------------------
# Permissions
#
# CI does not publish artifacts.
# Read-only permissions are sufficient.
# -----------------------------------------------------------------------------

permissions:
  contents: read


# -----------------------------------------------------------------------------
# Jobs
# -----------------------------------------------------------------------------

jobs:

  # ===========================================================================
  # Build job
  #
  # Purpose:
  # - Build the container image from the current repository state
  # - Fail fast on Dockerfile or build-time errors
  #
  # The image is built locally and never published.
  # ===========================================================================

  build:
    name: Build and validate runner image
    runs-on: ubuntu-latest

    steps:

      # -----------------------------------------------------------------------
      # Source checkout
      # -----------------------------------------------------------------------

      - name: Checkout source
        uses: actions/checkout@v4


      # -----------------------------------------------------------------------
      # Build image (local only)
      #
      # The image is tagged locally for use by subsequent test jobs.
      # -----------------------------------------------------------------------

      - name: Build runner image
        shell: bash
        run: |
          set -Eeuo pipefail

          docker build \
            --tag runner-ci:${{ github.sha }} \
            .


      # ===========================================================================
      # Test steps
      #
      # Purpose:
      # - Execute the full runner contract test suite
      # - Validate execution model, identity, and invariants
      #
      # This job enforces the platform contract.
      # =========================================================================== 

     
      # -----------------------------------------------------------------------
      # Ensure test script executability
      #
      # Rationale:
      # - File mode may not be preserved across platforms (e.g. Windows checkouts)
      # - CI must be able to execute tests regardless of developer environment
      #
      # This step does NOT modify the committed source of truth.
      # -----------------------------------------------------------------------

      - name: Ensure CI test scripts are executable
        shell: bash
        run: |
          set -Eeuo pipefail

          for f in ci/*.sh; do
            [ -x "$f" ] || chmod 0755 "$f"
          done


      # -----------------------------------------------------------------------
      # Execute test suite
      #
      # Tests are executed:
      # - explicitly
      # - sequentially
      # - in a fixed order
      #
      # No test discovery or implicit ordering is used.
      # -----------------------------------------------------------------------

      - name: Execute contract test suite
        shell: bash
        env:
          IMAGE: runner-ci:${{ github.sha }}
        run: |
          set -Eeuo pipefail

          ./ci/test-smoke.sh
          ./ci/test-image-identity.sh
          ./ci/test-runner-core.sh
          ./ci/test-negative.sh
          # ./ci/test-runner-plugin.sh
          # ./ci/test-domain.sh


# -----------------------------------------------------------------------------
# End of workflow
#
# CONTRACT GUARANTEES
# -------------------
# - CI always builds the image from the current repository state.
# - CI validates the full runner execution contract.
# - CI never publishes images or artifacts.
# - CI behavior is deterministic and environment-independent.
# =============================================================================
