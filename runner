#!/usr/bin/env bash
# =============================================================================
# runner — deterministic command dispatcher
#
# PURPOSE
# -------
# Single entrypoint for all runner-based images.
#
# DESIGN PRINCIPLES
# -----------------
# - Explicit behavior (no guessing, no fallbacks)
# - Deterministic dispatch (1 command → 1 plugin)
# - Manifest- and contract-driven
# - Readable and auditable over many years
#
# ARCHITECTURE
# ------------
# - runner      → command dispatcher
# - runner.d/*  → single-purpose plugins (1 tool = 1 plugin)
#
# Plugins NEVER self-dispatch.
# Plugins NEVER receive the command name.
#
# =============================================================================

set -Eeuo pipefail

# =============================================================================
# Fixed platform locations (CONTRACT)
# =============================================================================

readonly PLUGIN_DIR="/usr/local/lib/runner.d"

readonly IMAGE_ENV="/etc/runner/image.env"
readonly RUNTIME_ENV="/etc/runner/runtime.env"
readonly TOOLS_ENV="/etc/runner/tools.env"

# =============================================================================
# Helpers
# =============================================================================

die() {
  echo "ERROR: $*" >&2
  exit 1
}

heading() {
  echo "$1:"
}

indent() {
  sed 's/^/  /'
}

# =============================================================================
# Load runtime contracts (READ-ONLY)
# =============================================================================

[[ -f "$IMAGE_ENV" ]]   || die "missing image contract (${IMAGE_ENV})"
[[ -f "$RUNTIME_ENV" ]] || die "missing runtime contract (${RUNTIME_ENV})"

# shellcheck disable=SC1090
source "$IMAGE_ENV"
# shellcheck disable=SC1090
source "$RUNTIME_ENV"

# Optional tools metadata
if [[ -f "$TOOLS_ENV" ]]; then
  # shellcheck disable=SC1090
  source "$TOOLS_ENV"
fi

# =============================================================================
# Core commands (BUILT-IN)
# =============================================================================

runner_help() {
  heading " RUNNER - command dispatcher"
  cat <<'EOF'

Usage:
  <image> <command> [arguments]

Core commands:
  help            Show this help
  about           Show image identity
  info            Show runtime environment and tools
  version         Show provided tool versions
  exec <cmd>      Execute command explicitly
  shell           Start interactive shell (human use only)

Notes:
- Commands must be explicit
- No implicit shell or fallback execution
- Additional commands are provided by image-specific plugins
EOF
}

runner_about() {
  heading "Image identity"
  cat <<EOF | indent
Name:        ${RUNNER_IMAGE}
Domain:      ${RUNNER_DOMAIN}
Role:        ${RUNNER_ROLE}
Description: ${RUNNER_DESCRIPTION}
Vendor:      ${RUNNER_VENDOR}
Repository:  ${RUNNER_REPOSITORY}
EOF
}

runner_info() {
  heading "Image identity"
  cat <<EOF | indent
Name:   ${RUNNER_IMAGE}
Domain: ${RUNNER_DOMAIN}
Role:   ${RUNNER_ROLE}
EOF

  echo
  heading "Runtime contract"
  cat <<EOF | indent
User:    ${RUNTIME_USER_NAME} (${RUNTIME_USER_UID}:${RUNTIME_USER_GID})
Home:    ${RUNTIME_USER_HOME}
Shell:   ${RUNTIME_SHELL}
Workdir: ${RUNTIME_WORKDIR}
EOF

  echo
  heading "Runtime state"
  cat <<EOF | indent
User:    $(id -un) ($(id -u):$(id -g))
Home:    ${HOME}
Shell:   $(command -v "${RUNTIME_SHELL}" 2>/dev/null || echo unknown)
Workdir: $(pwd)
EOF

  echo
  heading "Tools"
  if [[ -s "$TOOLS_ENV" ]]; then
    sed 's/^/  /' "$TOOLS_ENV"
  else
    echo "  (none)"
  fi

  echo
  heading "Plugins"
  if [[ -d "$PLUGIN_DIR" ]] && ls "$PLUGIN_DIR"/* >/dev/null 2>&1; then
    for f in "$PLUGIN_DIR"/*; do
      [[ -x "$f" ]] || continue
      echo "  - $(basename "$f")"
    done
  else
    echo "  (none)"
  fi
}

runner_exec() {
  [[ $# -gt 0 ]] || die "exec requires a command"
  exec "$@"
}

runner_shell() {
  [[ -t 0 ]] || die "shell requires an interactive terminal (use -it)"
  exec "${RUNTIME_SHELL}"
}

runner_version() {
  # Prefer plugin-provided version (image-specific UX)
  local plugin="${PLUGIN_DIR}/version"

  if [[ -x "$plugin" ]]; then
    exec "$plugin"
  fi

  heading "Tool versions"

  # Manifest-driven tool versions
  if [[ -s "$TOOLS_ENV" ]]; then
    sed 's/^TOOL_//' "$TOOLS_ENV" | grep '_VERSION=' | sort | indent
    return 0
  fi

  echo "(no version information provided by this image)" | indent
  exit 0
}

# =============================================================================
# Main dispatch (DETERMINISTIC)
# =============================================================================

CMD="${1:-help}"
shift || true

case "$CMD" in
  help)    runner_help ;;
  about)   runner_about ;;
  info)    runner_info ;;
  exec)    runner_exec "$@" ;;
  shell)   runner_shell ;;
  version) runner_version ;;
  *)
    plugin="${PLUGIN_DIR}/${CMD}"

    if [[ -x "$plugin" ]]; then
      exec "$plugin" "$@"
    fi

    die "unknown command: ${CMD}"
    ;;
esac
